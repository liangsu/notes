# mybatis

## 基础结构：
* org.apache.ibatis.session.Configuration：
	* Map<String, MappedStatement> mappedStatements： 存放sql的类

* MapperProxy
	* Map<Method, MapperMethod/MybatisMapperMethod> methodCache: 存放每个方法的执行sql的方式
	

## 拦截器
* mybatis拦截器讲解： https://www.cnblogs.com/fangjian0423/p/mybatis-interceptor.html
* 存放所有的拦截器： org.apache.ibatis.plugin.InterceptorChain
* 用于获取一个对象的可用拦截器： org.apache.ibatis.plugin.InterceptorChain#pluginAll 
* 判断本拦截器是否适用于某个类： org.apache.ibatis.plugin.Interceptor#plugin
* 判断某个类是否能使用这个拦截器： org.apache.ibatis.plugin.Plugin#wrap ，且Plugin是创建的代理处理器，该类的invoke方法是真正判断是否调用interceptor方法

## mybatis查询执行顺序：
* sqlSessionTemplate执行select查询 -> 获取sqlsessionFactory ------> 开启sqlSession (包含executor) ---> 执行executor的query(4个参数) --> 执行executor的query(6个参数) --> 执行statementHandler.query
```
interceptor3（4个参数）
interceptor2 （4个参数）
	query(6个参数)
interceptor1 (6个参数)
```

## mybatis的mapper
* mapper的代理类： org.apache.ibatis.binding.MapperProxy
* spring与mybatis结合生成mapper的bean类：mapperFactoryBean


## sql解析
* 解析类：org.apache.ibatis.builder.SqlSourceBuilder


# mybatis-pagehelper：
* 分页核心类拦截器： com.github.pagehelper.PageInterceptor
* pagehelper拦截器详解： https://github.com/pagehelper/Mybatis-PageHelper/blob/master/wikis/zh/Interceptor.md
* 疑问：既然query(4个参数)的方法，最终会调用query(6个参数)的方法，为什么PageInterceptor不做成只拦截query(6个参数)，这样还不会打乱拦截器的执行顺序

# mybatis-plus: 
* 通过重写sqlSessionFactory类来达到生成简单的crud方法，springboot的默认配置重新类：MybatisPlusAutoConfiguration#sqlSessionFactory
* mapper简单CRUD的xml解析注入接口：com.baomidou.mybatisplus.core.injector.ISqlInjector

* 填充主键： com.baomidou.mybatisplus.core.MybatisDefaultParameterHandler#populateKeys

# mybatis-plus中使用缓存
>> 只有通过id获取对象的方法才使用缓存，其它的update、insert、delete方法清空缓存
* 

				
/*mycat: datanode=dn1*/select count(*) from dth_affair;




1. 将主键字段都改为id，如sys_user表的user_id改为id，
	* 注意修改model.java
	* 注意修改mapper.xml文件，以及使用了这张表的其它xml文件
	* 注意修改页面上的html
2. 将所有的mapper接口类，继承自com.sccl.base.mapper.MybatisMapper


1. 使用mybatis-plus修改分页查询
2. 增加根据id、shardKey的查询方法

	
	

	
	
	
	
1. 部分更新
2. 即使为空也更新
<if test="affairName!= null  and affairName !='' ">	
	
	
<script>
INSERT INTO SYS_USER_GROUP <trim prefix="(" suffix=")" suffixOverrides=",">
id,
<if test="createUserId != null">create_user_id,</if>
<if test="deleted != null">deleted,</if>
<if test="expireTime != null">expire_time,</if>
<if test="createTime != null">create_time,</if>
<if test="name != null">name,</if>
<if test="sign != null">sign,</if>
<if test="structureId != null">structure_id,</if>
<if test="updateTime != null">update_time,</if>
<if test="dead != null">dead,</if>
<if test="type != null">type,</if>
</trim> VALUES <trim prefix="(" suffix=")" suffixOverrides=",">
#{id},
<if test="createUserId != null">#{createUserId},</if>
<if test="deleted != null">#{deleted},</if>
<if test="expireTime != null">#{expireTime},</if>
<if test="createTime != null">#{createTime},</if>
<if test="name != null">#{name},</if>
<if test="sign != null">#{sign},</if>
<if test="structureId != null">#{structureId},</if>
<if test="updateTime != null">#{updateTime},</if>
<if test="dead != null">#{dead},</if>
<if test="type != null">#{type},</if>
</trim>
</script>




